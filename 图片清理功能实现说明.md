# 图片清理功能实现说明

## 功能概述

在编辑博客内容后，系统会自动对比编辑前后的内容，找出被删除的图片，并调用后端API清理这些不再使用的图片文件，避免存储空间浪费。

## 实现原理

### 1. 内容对比机制

- 在编辑开始时保存原始内容
- 在提交成功后对比原始内容和新内容
- 找出在原始内容中存在但在新内容中不存在的图片

### 2. 图片URL提取

- 支持Markdown图片语法：`![alt](url)`
- 支持HTML img标签：`<img src="url" ...>`
- 使用正则表达式提取所有图片URL

### 3. 批量删除处理

- 收集所有被删除的图片URL
- 调用后端API批量删除
- 处理删除失败的情况，不影响文章更新

## 前端实现

### 1. 数据存储

```typescript
// 保存编辑前的原始内容，用于对比图片差异
const originalContent = ref('')

// 在获取博客文章详情时保存原始内容
const fetchBlogPost = async () => {
  // ... 获取文章详情
  originalContent.value = post.content // 保存原始内容
}
```

### 2. 图片URL提取函数

```typescript
// 从内容中提取所有图片URL
const extractImageUrls = (content: string): string[] => {
  const urls: string[] = []

  // 匹配Markdown图片语法 ![alt](url)
  const markdownImages = content.match(/!\[([^\]]*)\]\(([^)]+)\)/g)
  if (markdownImages) {
    markdownImages.forEach((match) => {
      const urlMatch = match.match(/!\[([^\]]*)\]\(([^)]+)\)/)
      if (urlMatch && urlMatch[2]) {
        urls.push(urlMatch[2])
      }
    })
  }

  // 匹配HTML img标签
  const htmlImages = content.match(/<img[^>]+src="([^"]+)"/gi)
  if (htmlImages) {
    htmlImages.forEach((match) => {
      const urlMatch = match.match(/<img[^>]+src="([^"]+)"/i)
      if (urlMatch && urlMatch[1]) {
        urls.push(urlMatch[1])
      }
    })
  }

  return urls
}
```

### 3. 图片差异对比

```typescript
// 对比编辑前后的图片差异，找出被删除的图片
const getDeletedImages = (originalContent: string, newContent: string): string[] => {
  const originalImages = extractImageUrls(originalContent)
  const newImages = extractImageUrls(newContent)

  // 找出在原始内容中存在但在新内容中不存在的图片
  return originalImages.filter((img) => !newImages.includes(img))
}
```

### 4. 图片删除处理

```typescript
// 删除已删除的图片
const deleteUnusedImages = async (deletedImages: string[]): Promise<void> => {
  if (deletedImages.length === 0) return

  try {
    // 调用后端API删除这些图片
    await axios.post('/api/uploads/delete-unused', {
      imageUrls: deletedImages,
    })

    console.log(`成功删除 ${deletedImages.length} 张未使用的图片`)
  } catch (error) {
    console.error('删除未使用的图片失败:', error)
    // 不阻止文章更新，只记录错误
  }
}
```

### 5. 集成到提交流程

```typescript
// 提交表单
const submitForm = async () => {
  try {
    submitting.value = true

    // 先更新文章内容
    await axios.put(`/api/posts/${postId.value}`, {
      // ... 文章数据
    })

    // 更新成功后，清理已删除的图片
    const deletedImages = getDeletedImages(originalContent.value, form.value.content)
    if (deletedImages.length > 0) {
      await deleteUnusedImages(deletedImages)
      console.log(`清理了 ${deletedImages.length} 张已删除的图片`)
    }

    ElMessage.success('博客文章更新成功')
    returnToSource()
  } catch (error) {
    // 错误处理
  } finally {
    submitting.value = false
  }
}
```

## 后端API要求

### 接口规范

- **地址**: `POST /api/uploads/delete-unused`
- **请求体**: `{ "imageUrls": ["url1", "url2", ...] }`
- **响应**: `{ "success": true, "deletedCount": 3, "failedUrls": [] }`

### 实现要点

1. 权限验证：确保用户有权限删除图片
2. 路径验证：防止路径遍历攻击
3. 文件类型验证：只允许删除图片文件
4. 错误处理：处理文件不存在、权限不足等情况
5. 日志记录：记录所有删除操作

## 使用场景

### 1. 编辑博客文章

- 用户删除文章中的某些图片
- 系统自动清理这些已删除的图片文件

### 2. 替换图片

- 用户用新图片替换旧图片
- 系统自动清理旧图片文件

### 3. 删除文章

- 用户删除整个博客文章
- 系统清理文章中的所有图片（需要额外实现）

## 优势特点

### 1. 自动化

- 无需手动清理，系统自动处理
- 减少用户操作步骤

### 2. 安全性

- 只删除确实不再使用的图片
- 不影响正在使用的图片

### 3. 效率性

- 批量删除，提高处理效率
- 异步处理，不阻塞文章更新

### 4. 可靠性

- 删除失败不影响文章更新
- 详细的错误日志记录

## 注意事项

### 1. 性能考虑

- 图片URL提取使用正则表达式，性能较好
- 批量删除减少网络请求次数

### 2. 错误处理

- 删除失败不影响主要功能
- 记录详细错误信息便于排查

### 3. 安全考虑

- 验证用户权限
- 防止恶意删除其他用户的图片

### 4. 兼容性

- 支持Markdown和HTML两种图片语法
- 兼容不同的图片URL格式

## 测试建议

### 1. 功能测试

- 测试删除单张图片的清理
- 测试删除多张图片的清理
- 测试替换图片的清理

### 2. 边界测试

- 测试没有图片的情况
- 测试所有图片都被删除的情况
- 测试图片URL格式异常的情况

### 3. 错误测试

- 测试后端API失败的情况
- 测试网络异常的情况
- 测试权限不足的情况

## 总结

图片清理功能实现了编辑博客后自动清理已删除图片的需求，通过内容对比、URL提取和批量删除等机制，有效提高了系统效率，减少了存储空间浪费。该功能设计合理、实现安全、使用便捷，是博客系统的重要优化功能。
