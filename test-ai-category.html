<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI分类生成测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .form-group {
        margin: 15px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      button {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background: #409eff;
        color: white;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #337ecc;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        background: #f5f7fa;
        border-radius: 4px;
        white-space: pre-wrap;
      }
      .error {
        background: #fef0f0;
        color: #f56c6c;
        border: 1px solid #fbc4c4;
      }
      .success {
        background: #f0f9ff;
        color: #409eff;
        border: 1px solid #bae6fd;
      }
    </style>
  </head>
  <body>
    <h1>AI分类生成功能测试</h1>

    <div class="test-section">
      <h2>测试1: 直接调用Ollama API</h2>
      <div class="form-group">
        <label>分类名称:</label>
        <input type="text" id="categoryName1" value="开发工具" placeholder="输入分类名称" />
      </div>
      <button onclick="testOllamaDirect()">测试Ollama API</button>
      <div id="result1" class="result"></div>
    </div>

    <div class="test-section">
      <h2>测试2: 检查Ollama服务状态</h2>
      <button onclick="checkOllamaStatus()">检查服务状态</button>
      <div id="result2" class="result"></div>
    </div>

    <div class="test-section">
      <h2>测试3: 查看可用模型</h2>
      <button onclick="listModels()">列出可用模型</button>
      <div id="result3" class="result"></div>
    </div>

    <div class="test-section">
      <h2>测试4: 测试Vue组件中的AI函数</h2>
      <div class="form-group">
        <label>分类名称:</label>
        <input type="text" id="categoryName2" value="开发工具" placeholder="输入分类名称" />
      </div>
      <button onclick="testVueAIFunction()">测试Vue AI函数</button>
      <div id="result4" class="result"></div>
    </div>

    <script>
      async function testOllamaDirect() {
        const categoryName = document.getElementById('categoryName1').value
        const resultDiv = document.getElementById('result1')

        if (!categoryName) {
          resultDiv.className = 'result error'
          resultDiv.textContent = '请输入分类名称'
          return
        }

        resultDiv.className = 'result'
        resultDiv.textContent = '正在测试...'

        try {
          const prompt = `你是一个专业的网站分类助手。请为博客分类"${categoryName}"生成以下内容：

1. 分类描述：生成一个简洁、专业的分类描述，说明这个分类包含什么类型的博客文章，主题是什么。描述应该简洁明了，不超过50个字。

2. 分类颜色：为这个分类推荐一个合适的颜色，颜色应该与分类主题相关，并且适合在网页上显示。请返回一个十六进制颜色代码（如#409EFF）。

重要：你必须严格按照以下JSON格式返回，不要添加任何其他内容，不要使用markdown格式：

{
  "description": "分类描述内容",
  "color": "#颜色代码"
}`

          const response = await fetch('http://localhost:11434/api/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'qwen3:8b',
              prompt: prompt,
              stream: false,
              options: {
                temperature: 0.7,
                top_p: 0.9,
                max_tokens: 500,
              },
            }),
          })

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const data = await response.json()
          resultDiv.className = 'result success'
          resultDiv.textContent = `成功！AI响应：\n\n${JSON.stringify(data, null, 2)}`
        } catch (error) {
          resultDiv.className = 'result error'
          resultDiv.textContent = `错误：${error.message}`
          console.error('测试失败:', error)
        }
      }

      async function checkOllamaStatus() {
        const resultDiv = document.getElementById('result2')
        resultDiv.className = 'result'
        resultDiv.textContent = '正在检查...'

        try {
          const response = await fetch('http://localhost:11434/api/tags')
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const data = await response.json()
          resultDiv.className = 'result success'
          resultDiv.textContent = `Ollama服务正常！\n\n响应：\n${JSON.stringify(data, null, 2)}`
        } catch (error) {
          resultDiv.className = 'result error'
          resultDiv.textContent = `Ollama服务不可用：${error.message}`
          console.error('状态检查失败:', error)
        }
      }

      async function listModels() {
        const resultDiv = document.getElementById('result3')
        resultDiv.className = 'result'
        resultDiv.textContent = '正在获取模型列表...'

        try {
          const response = await fetch('http://localhost:11434/api/tags')
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const data = await response.json()
          const models = data.models || []

          resultDiv.className = 'result success'
          resultDiv.textContent = `可用模型：\n\n${models.map((m) => `- ${m.name} (${m.size} bytes)`).join('\n')}`
        } catch (error) {
          resultDiv.className = 'result error'
          resultDiv.textContent = `获取模型列表失败：${error.message}`
          console.error('获取模型列表失败:', error)
        }
      }

      async function testVueAIFunction() {
        const categoryName = document.getElementById('categoryName2').value
        const resultDiv = document.getElementById('result4')

        if (!categoryName) {
          resultDiv.className = 'result error'
          resultDiv.textContent = '请输入分类名称'
          return
        }

        resultDiv.className = 'result'
        resultDiv.textContent = '正在测试Vue组件中的AI函数...'

        try {
          // 模拟Vue组件中的AI函数调用
          const prompt = `你是一个专业的网站分类助手。请为博客分类"${categoryName}"生成以下内容：

1. 分类描述：生成一个简洁、专业的分类描述，说明这个分类包含什么类型的博客文章，主题是什么。描述应该简洁明了，不超过50个字。

2. 分类颜色：为这个分类推荐一个合适的颜色，颜色应该与分类主题相关，并且适合在网页上显示。请返回一个十六进制颜色代码（如#409EFF）。

重要：你必须严格按照以下JSON格式返回，不要添加任何其他内容，不要使用markdown格式：

{
  "description": "分类描述内容",
  "color": "#颜色代码"
}`

          console.log('发送到Ollama的提示词:', prompt)

          const response = await fetch('http://localhost:11434/api/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'qwen3:8b',
              prompt: prompt,
              stream: false,
              options: {
                temperature: 0.7,
                top_p: 0.9,
                max_tokens: 500,
              },
            }),
          })

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const data = await response.json()
          console.log('Ollama原始响应:', data)

          // 尝试解析AI响应
          const aiResponse = data.response
          let parsedResult = null

          try {
            // 尝试从响应中提取JSON
            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/)
            if (jsonMatch) {
              parsedResult = JSON.parse(jsonMatch[0])
            }
          } catch (parseError) {
            console.warn('JSON解析失败:', parseError)
          }

          if (parsedResult && parsedResult.description && parsedResult.color) {
            resultDiv.className = 'result success'
            resultDiv.textContent = `Vue AI函数测试成功！\n\n解析结果：\n描述: ${parsedResult.description}\n颜色: ${parsedResult.color}\n\n原始AI响应:\n${aiResponse}`
          } else {
            resultDiv.className = 'result error'
            resultDiv.textContent = `AI响应格式不正确\n\n原始响应:\n${aiResponse}\n\n解析结果:\n${JSON.stringify(parsedResult, null, 2)}`
          }
        } catch (error) {
          resultDiv.className = 'result error'
          resultDiv.textContent = `测试失败：${error.message}`
          console.error('Vue AI函数测试失败:', error)
        }
      }
    </script>
  </body>
</html>
