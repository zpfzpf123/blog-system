<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI问答功能测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        white-space: pre-wrap;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
    </style>
  </head>
  <body>
    <h1>AI问答功能测试</h1>

    <div class="test-section">
      <h2>1. 测试Ollama服务连接</h2>
      <button onclick="testConnection()">测试连接</button>
      <div id="connection-result" class="result"></div>
    </div>

    <div class="test-section">
      <h2>2. 获取可用模型列表</h2>
      <button onclick="getModels()">获取模型</button>
      <div id="models-result" class="result"></div>
    </div>

    <div class="test-section">
      <h2>3. 测试AI对话</h2>
      <input
        type="text"
        id="test-input"
        placeholder="输入测试问题"
        style="width: 300px; padding: 8px; margin-right: 10px"
      />
      <button onclick="testChat()">发送消息</button>
      <div id="chat-result" class="result"></div>
    </div>

    <script>
      const OLLAMA_BASE_URL = 'http://localhost:11434'

      async function testConnection() {
        const resultDiv = document.getElementById('connection-result')
        resultDiv.textContent = '测试中...'
        resultDiv.className = 'result'

        try {
          const response = await fetch(`${OLLAMA_BASE_URL}/api/tags`)
          if (response.ok) {
            resultDiv.textContent = '✅ Ollama服务连接成功！'
            resultDiv.className = 'result success'
          } else {
            throw new Error(`HTTP ${response.status}`)
          }
        } catch (error) {
          resultDiv.textContent = `❌ 连接失败: ${error.message}\n\n请确保：\n1. Ollama服务已启动\n2. 服务地址为 http://localhost:11434\n3. 没有防火墙阻止连接`
          resultDiv.className = 'result error'
        }
      }

      async function getModels() {
        const resultDiv = document.getElementById('models-result')
        resultDiv.textContent = '获取中...'
        resultDiv.className = 'result'

        try {
          const response = await fetch(`${OLLAMA_BASE_URL}/api/tags`)
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`)
          }

          const data = await response.json()
          const models = data.models || []

          if (models.length === 0) {
            resultDiv.textContent =
              '⚠️ 没有找到可用的模型\n\n请先下载模型，例如：\nollama pull qwen3:8b'
            resultDiv.className = 'result error'
          } else {
            const modelList = models
              .map((model) => `- ${model.name} (${formatSize(model.size)})`)
              .join('\n')

            resultDiv.textContent = `✅ 找到 ${models.length} 个模型：\n\n${modelList}`
            resultDiv.className = 'result success'
          }
        } catch (error) {
          resultDiv.textContent = `❌ 获取模型失败: ${error.message}`
          resultDiv.className = 'result error'
        }
      }

      async function testChat() {
        const input = document.getElementById('test-input').value.trim()
        const resultDiv = document.getElementById('chat-result')

        if (!input) {
          resultDiv.textContent = '请输入测试问题'
          resultDiv.className = 'result error'
          return
        }

        resultDiv.textContent = '发送中...'
        resultDiv.className = 'result'

        try {
          // 先获取模型列表
          const modelsResponse = await fetch(`${OLLAMA_BASE_URL}/api/tags`)
          if (!modelsResponse.ok) {
            throw new Error('无法获取模型列表')
          }

          const modelsData = await modelsResponse.json()
          const models = modelsData.models || []

          if (models.length === 0) {
            throw new Error('没有可用的模型')
          }

          // 选择第一个可用模型
          const selectedModel = models[0].name

          const response = await fetch(`${OLLAMA_BASE_URL}/api/generate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: selectedModel,
              prompt: input,
              stream: false,
            }),
          })

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`)
          }

          const data = await response.json()

          resultDiv.textContent = `✅ 测试成功！\n\n问题: ${input}\n\n回答: ${data.response || '无回复'}`
          resultDiv.className = 'result success'
        } catch (error) {
          resultDiv.textContent = `❌ 测试失败: ${error.message}`
          resultDiv.className = 'result error'
        }
      }

      function formatSize(bytes) {
        if (bytes >= 1024 * 1024 * 1024) {
          return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)}GB`
        } else if (bytes >= 1024 * 1024) {
          return `${(bytes / (1024 * 1024)).toFixed(1)}MB`
        } else {
          return `${(bytes / 1024).toFixed(1)}KB`
        }
      }

      // 页面加载时自动测试连接
      window.onload = function () {
        testConnection()
      }
    </script>
  </body>
</html>
